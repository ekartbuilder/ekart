<?php
$all_finds = array(
	'@<\?php \$([a-z_-]+) \= \'([^\']+)\'; \?>@i',
	'@<\?php echo \(\$([^?$]+) \? ([^:$]+) : ([^)$]+)\); \?>@i',
	'@<\?php echo \(isset\(\$([^?$]+)\[\$([^)]+)\) \? \$([^?$]+)\[\$([^:]+) : \'\'\); \?>@i',
	'@<\?php echo \(isset\(\$([^?$]+)\[\$([^)]+)\) \? \$([^?$]+)\[\$([^:]+) : \$([^;]+)\); \?>@i',	
	'@<\?php echo \$([^;]+); \?>@i',
	'@<\?php if \(\$([^\$]+)\) \{ \?>@i',
	'@<\?php if \(\$([^\$]+) == \$([^\$]+)\) \{ \?>@i',
	'@<\?php if \(\$([a-z_-]+) \&\& \$([a-z_-]+)\) \{ \?>@i',
	'@<\?php \} elseif \(\$([a-z_-]+) \|\| \$([a-z_-]+)\) \{ \?>@i',
	'@<\?php \} else \{ \?>@i',
	'@<\?php \} \?>@i',
	'@<\?php if \(isset\(\$([^$]+)\[\$([^$\)]+)\)\) \{ \?>@i',
	'@<\?php if \(isset\(\$([^$]+)\[\$([^$\)]+)\) \&\& \$([^$]+) \=\= \$([^$]+)\[\$([^$]+)\) \{ \?>@i',
	'@<\?php foreach \(\$([^$]+) as \$([^$]+)\) \{ \?>@i',
);

$all_replaces = array(
	'{% set \1 = \'\2\' %}',
	'{{ (\1) ? \2 : \3 }}',
	'{{ (\1[\2) ? \3[\4 : \'\' }}',
	'{{ (\1[\2) ? \3[\4 : \5 }}',	
	'{{ \1 }}',
	'{% if \1 %}',
	'{% if \1 == \2 %}',
	'{% if \1 and \2 %}',
	'{% elseif \1 or \2 %}',
	'{% else %}',
	'{% endif %}',
	'{% if \1[\2 %}',
	'{% if \1[\2 and (\3 == \4[\5) %}',
	'{% for \2 in \1 %}',
);

$all_files = glob("template/*/*.tpl");
$all_matches = array();
foreach ($all_files as $each_file) {
	$data = file_get_contents($each_file);	
	$output = preg_replace($all_finds, $all_replaces, $data);
	file_put_contents($each_file, $output);
}
?>